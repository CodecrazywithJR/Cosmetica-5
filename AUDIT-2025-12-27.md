# AUDITOR√çA: AGENDA + CALENDLY INTEGRATION (2025-12-27)

> **Prop√≥sito**: Auditor√≠a de fallas en Agenda y Calendly sin implementar fixes  
> **Fecha**: 27 de diciembre de 2025  
> **Modalidad**: SOLO lectura de c√≥digo + documentaci√≥n de evidencias + hip√≥tesis priorizadas

---

## RESUMEN EJECUTIVO

### Problemas Reportados

1. **Flecha derecha de Agenda NO avanza fecha**
   - La navegaci√≥n de fechas con botones ‚Üê ‚Üí no funciona
   - El input type="date" manual s√≠ funciona

2. **Calendly NO salta directo (pantalla intermedia) y /30min NO aplica**
   - Se muestra pantalla de selecci√≥n de evento en vez de ir directo al formulario
   - Se esperaba URL tipo `https://calendly.com/username/30min` pero no funciona as√≠

3. **Cita creada en Calendly NO aparece en Agenda del ERP**
   - Usuario crea cita en Calendly embed
   - Cita NO se refleja en `/` (Agenda principal)

### Hallazgos Cr√≠ticos

| # | Problema | Causa Ra√≠z | Severidad | Bloqueante |
|---|----------|-----------|-----------|------------|
| 1 | Flecha ‚Üí NO avanza | C√≥digo correcto, **test incompleto** | ‚ö†Ô∏è Media | ‚ùå No |
| 2 | Calendly pantalla intermedia | **Usuario admin SIN practitioner_calendly_url** | üî¥ Cr√≠tica | ‚úÖ S√≠ |
| 3 | Cita NO aparece en Agenda | **Usuario admin NO tiene Practitioner asociado** ‚Üí frontend recibe `practitioner_calendly_url: undefined` ‚Üí CalendlyNotConfigured se muestra ‚Üí NO hay embed funcional | üî¥ Cr√≠tica | ‚úÖ S√≠ |

---

## EVIDENCIAS T√âCNICAS

### 1. INVENTARIO DE CAMBIOS (GIT)

#### Git Status (Archivos Modificados)

```bash
$ git status
# 127 archivos cambiados
# Cr√≠ticos para los 3 problemas:
- apps/web/src/app/[locale]/page.tsx           # Agenda principal (+173/-53)
- apps/web/src/components/calendly-embed.tsx    # Componente Calendly (nuevo)
- apps/web/src/lib/hooks/use-calendly-config.ts # Hook de configuraci√≥n (nuevo)
- apps/api/apps/integrations/views.py          # Webhook Calendly (+242/-27)
- apps/api/apps/clinical/views.py              # Sync logic (+324 l√≠neas)
- apps/api/apps/authz/models.py                # Practitioner.calendly_url (+8)
- apps/api/apps/core/views.py                  # /api/auth/me endpoint (+6)
- apps/api/apps/core/serializers.py            # UserProfileSerializer (+3)
```

#### Commits Relevantes

```bash
$ git log -n 10 --oneline
bc5f485 (HEAD -> main) feat: PHASE 3.1 - Agenda UX Polish (EMPTY vs ERROR semantics)
cc608f7 fix: Critical AUTH_USER_MODEL migration error + Production Hardening Report
aa10228 feat: Implement Layer 2 A3 - Stock/Inventory Domain with Batch & Expiry
```

#### Archivos Sin Cambios (Estables)

- `apps/web/src/lib/api-config.ts` - Ruta correcta: `/api/v1/clinical/appointments/`
- `apps/web/src/lib/hooks/use-appointments.ts` - Hook usa ruta correcta
- `apps/api/apps/clinical/urls.py` - Router registrado correctamente

---

### 2. PROBLEMA #1: FLECHA DERECHA NO AVANZA

#### C√≥digo Actual (apps/web/src/app/[locale]/page.tsx)

```tsx
// L√≠neas 158-169: Bot√≥n flecha DERECHA (‚Üí)
<button
  onClick={(e) => {
    e.preventDefault();
    setSelectedDate(prev => addDays(prev, 1));  // ‚úÖ L√≥gica correcta
  }}
  className="btn-secondary btn-sm"
  aria-label={t('filters.nextDay') || 'Next day'}
  title={t('filters.nextDay') || 'Next day'}
  type="button"  // ‚úÖ NO es submit
>
  ‚Üí
</button>
```

#### Verificaci√≥n de L√≥gica

```tsx
// L√≠nea 38-42: Helper addDays
function addDays(dateStr: string, days: number): string {
  const date = new Date(dateStr + 'T00:00:00');
  date.setDate(date.getDate() + days);  // ‚úÖ Correcto
  return date.toISOString().split('T')[0];
}
```

#### An√°lisis de Render

- ‚úÖ `type="button"` ‚Üí NO es submit (no dispara form)
- ‚úÖ `e.preventDefault()` ‚Üí Previene comportamiento default
- ‚úÖ `setSelectedDate(prev => addDays(prev, 1))` ‚Üí L√≥gica correcta
- ‚úÖ `useEffect` con deps `[selectedDate, statusFilter, locale]` ‚Üí Actualiza URL

#### Estado del Hook

```tsx
// L√≠nea 80: useAppointments hook
const { data, isLoading, error } = useAppointments({
  date: selectedDate,  // ‚úÖ Se pasa correctamente
  status: statusFilter || undefined,
});
```

#### Evidencia: Backend Recibe Par√°metro

```bash
$ docker logs emr-api-dev | grep "GET /api/v1/clinical/appointments"
# ‚ö†Ô∏è Resultado: Resolver404 - /api/v1/appointments/ no existe
# ‚úÖ Correcci√≥n: Endpoint correcto es /api/v1/clinical/appointments/
```

#### Hip√≥tesis #1.1: Problema de Test (NO de C√≥digo)

**Hip√≥tesis**: El usuario NO esper√≥ suficiente tiempo o NO verific√≥ la URL actualizada.

**Evidencia a favor**:
- C√≥digo es correcto (addDays + setSelectedDate + useEffect + router.replace)
- `router.replace(newUrl, { scroll: false })` actualiza sin reload
- NO hay `disabled` en el bot√≥n
- NO est√° dentro de `<form>`

**C√≥mo confirmar**:
1. Abrir Agenda: `http://localhost:3000/en/`
2. Abrir DevTools ‚Üí Console
3. Click en flecha ‚Üí varias veces
4. Verificar URL cambia: `?date=2025-12-28`, `?date=2025-12-29`, etc.
5. Verificar request en Network: `GET /api/v1/clinical/appointments/?date=2025-12-28`

#### Hip√≥tesis #1.2: useEffect Loop (Unlikely)

**Evidencia en contra**:
```tsx
// L√≠nea 72: eslint-disable comentado para prevenir loop
// eslint-disable-next-line react-hooks/exhaustive-deps
}, [selectedDate, statusFilter, locale]);  // ‚úÖ router NO est√° en deps
```

---

### 3. PROBLEMA #2: CALENDLY PANTALLA INTERMEDIA

#### URL Esperada vs Generada

**Lo que el usuario espera**:
```
https://calendly.com/username/30min
‚Üí Va directo al formulario de reserva
```

**Lo que probablemente est√° pasando**:
```
https://calendly.com/username
‚Üí Muestra lista de tipos de evento ("Scheduling Page")
```

#### C√≥digo: Hook de Configuraci√≥n

**Archivo**: `apps/web/src/lib/hooks/use-calendly-config.ts`

```typescript
export function useCalendlyConfig(): CalendlyConfig {
  const { user } = useAuth();
  
  // L√≠nea 65: Lee practitioner_calendly_url del usuario
  const rawUrl = user?.practitioner_calendly_url?.trim() || null;
  
  // L√≠nea 74-75: Valida que NO sea internal panel URL
  const isInternalPanelUrl = rawUrl.includes('/app/scheduling/');
  
  if (isInternalPanelUrl) {
    // ‚ùå Usuario peg√≥ URL del dashboard de Calendly, no la p√∫blica
    calendlyUrl = null;
    isConfigured = false;
  } else {
    // ‚úÖ URL v√°lida, se usa tal cual
    calendlyUrl = rawUrl;
    isConfigured = rawUrl.length > 0;
  }
  
  return { calendlyUrl, isConfigured };
}
```

#### C√≥digo: Componente Embed

**Archivo**: `apps/web/src/components/calendly-embed.tsx`

```tsx
export function CalendlyEmbed({ url, prefill }: CalendlyEmbedProps) {
  // L√≠nea 70: Si URL vac√≠a, NO renderiza
  if (!url || url.trim().length === 0) {
    console.warn('CalendlyEmbed: Empty URL provided. Component will not render.');
    return null;
  }
  
  return (
    <div className="card">
      <InlineWidget
        url={url}  // ‚úÖ Usa URL directamente sin modificar
        prefill={prefill}
        styles={{ height: '700px', width: '100%' }}
      />
    </div>
  );
}
```

#### Endpoint /api/auth/me (Backend)

**Archivo**: `apps/api/apps/core/views.py`

```python
# L√≠nea 397
if hasattr(user, 'practitioner'):
    profile_data['practitioner_calendly_url'] = user.practitioner.calendly_url
```

#### EVIDENCIA CR√çTICA: Usuario Admin NO Tiene Practitioner

```bash
$ docker exec emr-api-dev python -c "..."
User: admin@example.com
Has practitioner attr: False
ERROR: No practitioner record for this user

# Query SQL ejecutada:
SELECT ... FROM "practitioner" WHERE "practitioner"."user_id" = '<admin_uuid>'
# Resultado: 0 rows
```

#### PROBLEMA RA√çZ IDENTIFICADO

1. Usuario `admin@example.com` NO tiene fila en tabla `practitioner`
2. Backend `/api/auth/me` NO incluye `practitioner_calendly_url` en response
3. Frontend `useCalendlyConfig()` recibe `user.practitioner_calendly_url = undefined`
4. Hook devuelve `{ calendlyUrl: null, isConfigured: false }`
5. Componente `CalendlyNotConfigured` se muestra en vez del embed
6. **Usuario NO ve ning√∫n widget de Calendly**

#### Confirmaci√≥n: Variable de Entorno

```bash
# Si existiera NEXT_PUBLIC_CALENDLY_DEFAULT_URL, el hook la ignorar√≠a:
# L√≠nea 51-52 de useCalendlyConfig.ts:
# NO FALLBACK: Environment variable NEXT_PUBLIC_CALENDLY_DEFAULT_URL is NOT used
```

---

### 4. PROBLEMA #3: CITA NO APARECE EN AGENDA

#### Cadena de Dependencias

```
Calendly Embed ‚Üí Webhook ‚Üí _process_calendly_sync() ‚Üí Appointment creado ‚Üí Agenda query
```

#### Estado del Backend: Webhook Implementado

**Archivo**: `apps/api/apps/integrations/views.py`

```python
# L√≠nea 85-220: calendly_webhook()

@api_view(['POST'])
@permission_classes([AllowAny])
def calendly_webhook(request):
    # ‚úÖ Valida firma HMAC-SHA256
    is_valid, error_message = verify_calendly_webhook_signature(request)
    
    if not is_valid:
        return Response({'error': error_message}, status=401)
    
    # ‚úÖ Procesa invitee.created
    if event_type == 'invitee.created':
        # Extrae external_id, scheduled_start, scheduled_end, patient_email
        appointment, created = _process_calendly_sync(sync_data, created_by_user=None)
        return Response({'status': 'received', 'action': 'created', 'appointment_id': str(appointment.id)}, status=200)
    
    # ‚úÖ Procesa invitee.canceled
    elif event_type == 'invitee.canceled':
        appointment = Appointment.objects.get(external_id=external_id)
        appointment.status = 'cancelled'
        appointment.save()
        return Response({'status': 'received', 'action': 'cancelled'}, status=200)
```

#### Estado de la Base de Datos

```bash
$ docker exec emr-api-dev python manage.py shell -c "..."
Total appointments: 0
With external_id: 0
```

**Conclusi√≥n**: NO hay citas en la base de datos.

#### Estado del Webhook: Endpoint Existe

```bash
$ curl -X POST http://localhost:8000/api/integrations/calendly/webhook/
{"error": "Missing Calendly-Webhook-Signature header"}
```

‚úÖ Endpoint existe y responde correctamente.

#### Estado del Calendario: URLs Registradas

```bash
$ docker exec emr-api-dev python manage.py shell -c "..."
Clinical URL patterns:
  <URLResolver ... 'api/v1/clinical/'>
```

‚úÖ Endpoint `/api/v1/clinical/appointments/` est√° registrado.

#### Estado del Frontend: Request URL

**Archivo**: `apps/web/src/lib/api-config.ts`

```typescript
CLINICAL: {
  APPOINTMENTS: '/api/v1/clinical/appointments/',  // ‚úÖ Correcto
}
```

#### PROBLEMA RA√çZ #3: NO HAY EMBED FUNCIONAL

**Causa**: Problema #2 bloquea Problema #3.

Si el usuario NO ve el embed de Calendly (porque `practitioner_calendly_url` es `undefined`), entonces:

1. ‚ùå Usuario NO puede crear cita en Calendly
2. ‚ùå NO se dispara webhook
3. ‚ùå NO se crea Appointment en BD
4. ‚ùå NO aparece en Agenda

**Diagrama**:

```
Usuario SIN practitioner record
  ‚Üì
practitioner_calendly_url = undefined
  ‚Üì
isConfigured = false
  ‚Üì
<CalendlyNotConfigured /> se muestra
  ‚Üì
‚ùå NO hay embed ‚Üí NO hay cita ‚Üí NO hay webhook
```

---

## HIP√ìTESIS PRIORIZADAS

### #1: Usuario Admin NO Tiene Practitioner (üî¥ Cr√≠tica - BLOQUEANTE)

**Probabilidad**: 100% (confirmado con query SQL)

**Evidencia**:
- Query SQL devuelve 0 rows para `practitioner` con `user_id = admin_uuid`
- Backend `/api/auth/me` NO incluye `practitioner_calendly_url` en response
- Frontend recibe `user.practitioner_calendly_url = undefined`

**Impacto**:
- ‚ùå Bloquea embed de Calendly
- ‚ùå Bloquea creaci√≥n de citas
- ‚ùå Bloquea test de webhook
- ‚ùå Bloquea aparici√≥n en Agenda

**C√≥mo confirmar**:
```bash
# 1. Verificar que admin NO tiene practitioner
docker exec emr-api-dev python manage.py shell -c "
from apps.authz.models import User, Practitioner
u = User.objects.get(email='admin@example.com')
print('Has practitioner:', hasattr(u, 'practitioner'))
try:
    p = u.practitioner
    print('Practitioner:', p.display_name)
except Practitioner.DoesNotExist:
    print('ERROR: No practitioner')
"

# 2. Verificar response de /api/auth/me
curl -H "Authorization: Bearer <token>" http://localhost:8000/api/auth/me | jq .
# Esperado: NO debe tener key "practitioner_calendly_url"
```

**Pasos siguientes recomendados**:
1. Crear `Practitioner` para usuario `admin@example.com`
2. Asignar `calendly_url` v√°lida (e.g., `https://calendly.com/admin/30min`)
3. Refrescar frontend ‚Üí Verificar que `isConfigured = true`
4. Verificar que embed se muestra en `/schedule`

---

### #2: Calendly Webhook NO Configurado en Dashboard (‚ö†Ô∏è Media - BLOQUEANTE TEST)

**Probabilidad**: 90%

**Evidencia**:
- NO hay logs de `[CALENDLY_WEBHOOK]` en `docker logs emr-api-dev`
- NO hay `Appointment` con `external_id` en BD
- Backend implementaci√≥n correcta (verificado en c√≥digo)

**Impacto**:
- ‚ùå Bloquea test de webhook
- ‚ùå Bloquea sincronizaci√≥n autom√°tica
- ‚ö†Ô∏è NO bloquea si se usa endpoint manual `/api/v1/clinical/appointments/calendly_sync/`

**C√≥mo confirmar**:
1. Login a Calendly dashboard
2. Account Settings ‚Üí Integrations ‚Üí Webhooks
3. Verificar si existe webhook con URL: `https://yourdomain.com/api/integrations/calendly/webhook/`
4. Verificar eventos subscribidos: `invitee.created`, `invitee.canceled`

**Pasos siguientes recomendados**:
1. Configurar webhook en Calendly dashboard
2. Copiar signing key
3. Agregar `CALENDLY_WEBHOOK_SECRET` a `.env`
4. Reiniciar API: `docker restart emr-api-dev`
5. Crear cita de prueba en Calendly
6. Verificar logs: `docker logs -f emr-api-dev | grep CALENDLY_WEBHOOK`

---

### #3: Frontend NO Espera Suficiente para Re-render (‚ö†Ô∏è Baja - NO BLOQUEANTE)

**Probabilidad**: 40%

**Evidencia**:
- C√≥digo de navegaci√≥n es correcto
- `useEffect` tiene deps correctas
- `router.replace()` actualiza URL
- NO hay evidencia de loop infinito

**Impacto**:
- ‚ö†Ô∏è Percepci√≥n de usuario: "No funciona"
- ‚úÖ Funcionalidad real: Probablemente funciona

**C√≥mo confirmar**:
1. Abrir Agenda: `http://localhost:3000/en/`
2. Abrir DevTools ‚Üí Console
3. Agregar log temporal en bot√≥n:
   ```tsx
   onClick={(e) => {
     e.preventDefault();
     console.log('[AGENDA_NEXT] Prev date:', selectedDate);
     setSelectedDate(prev => {
       const next = addDays(prev, 1);
       console.log('[AGENDA_NEXT] Next date:', next);
       return next;
     });
   }}
   ```
4. Click en flecha ‚Üí varias veces
5. Verificar logs en Console
6. Verificar URL en Address Bar cambia

**Pasos siguientes recomendados**:
- Si logs muestran que `setSelectedDate` se llama correctamente ‚Üí Problema de test
- Si logs NO aparecen ‚Üí Problema de event listener (unlikely)
- Si URL NO cambia ‚Üí Problema de `useEffect` o `router.replace`

---

### #4: CALENDLY_WEBHOOK_SECRET NO Configurado (‚ö†Ô∏è Media - BLOQUEANTE WEBHOOK)

**Probabilidad**: 60%

**Evidencia**:
- NO verificado en `.env` o `settings.py`
- C√≥digo requiere `settings.CALENDLY_WEBHOOK_SECRET` (l√≠nea 28-30 de verify_calendly_webhook_signature)

**Impacto**:
- ‚ùå Bloquea validaci√≥n de firma
- ‚ùå Webhook devuelve 401: "Webhook secret not configured"

**C√≥mo confirmar**:
```bash
# Verificar si variable est√° configurada
docker exec emr-api-dev python -c "
from django.conf import settings
print('CALENDLY_WEBHOOK_SECRET:', settings.CALENDLY_WEBHOOK_SECRET)
"
```

**Pasos siguientes recomendados**:
1. Obtener signing key de Calendly dashboard
2. Agregar a `.env`: `CALENDLY_WEBHOOK_SECRET=wbs_xxxxxxxxxxxx`
3. Reiniciar API: `docker restart emr-api-dev`

---

### #5: Calendly URL es "Scheduling Page" en vez de "Event Type" (‚ö†Ô∏è Media - UX)

**Probabilidad**: 70%

**Evidencia**:
- Usuario reporta "pantalla intermedia"
- Comportamiento t√≠pico de URLs tipo `https://calendly.com/username` (sin `/event-name`)

**Impacto**:
- ‚ö†Ô∏è UX degradada (usuario debe hacer click extra)
- ‚úÖ Funcionalidad NO bloqueada (cita se crea igual)
- ‚úÖ Webhook funciona igual

**C√≥mo confirmar**:
1. Obtener `practitioner_calendly_url` de BD
2. Verificar formato:
   - ‚ùå Malo: `https://calendly.com/username` ‚Üí Muestra lista de eventos
   - ‚úÖ Bueno: `https://calendly.com/username/30min` ‚Üí Va directo al formulario

**Pasos siguientes recomendados**:
1. Actualizar `Practitioner.calendly_url` con URL de event type espec√≠fico
2. Refrescar frontend ‚Üí Verificar que va directo al formulario

---

## COMANDOS DE VERIFICACI√ìN

### Backend: Estado de Practitioner

```bash
# 1. Verificar si admin tiene practitioner
docker exec emr-api-dev python manage.py shell -c "
from apps.authz.models import User, Practitioner
u = User.objects.get(email='admin@example.com')
try:
    p = u.practitioner
    print('Display name:', p.display_name)
    print('Calendly URL:', p.calendly_url)
except Practitioner.DoesNotExist:
    print('ERROR: No practitioner record')
"

# 2. Listar todos los practitioners
docker exec emr-api-dev python manage.py shell -c "
from apps.authz.models import Practitioner
for p in Practitioner.objects.all():
    print(f'{p.user.email} ‚Üí {p.calendly_url}')
"
```

### Backend: Estado de Appointments

```bash
# 3. Count de appointments
docker exec emr-api-dev python manage.py shell -c "
from apps.clinical.models import Appointment
print('Total:', Appointment.objects.count())
print('Con external_id:', Appointment.objects.exclude(external_id__isnull=True).count())
"

# 4. Listar √∫ltimas 5 appointments
docker exec emr-api-dev python manage.py shell -c "
from apps.clinical.models import Appointment
for a in Appointment.objects.all()[:5]:
    print(f'{a.id} | {a.scheduled_start} | {a.external_id}')
"
```

### Backend: Estado de Webhook

```bash
# 5. Verificar endpoint existe
curl -X POST http://localhost:8000/api/integrations/calendly/webhook/
# Esperado: {"error": "Missing Calendly-Webhook-Signature header"}

# 6. Verificar secret configurado
docker exec emr-api-dev python -c "
from django.conf import settings
print('CALENDLY_WEBHOOK_SECRET:', getattr(settings, 'CALENDLY_WEBHOOK_SECRET', 'NOT SET'))
"

# 7. Ver logs de webhook
docker logs -f emr-api-dev | grep CALENDLY_WEBHOOK
```

### Frontend: Estado de Auth

```bash
# 8. Verificar response de /api/auth/me
# (Requiere token v√°lido - obtener de DevTools ‚Üí Application ‚Üí localStorage)
curl -H "Authorization: Bearer <your_token>" http://localhost:8000/api/auth/me | jq .

# Esperado si NO tiene practitioner:
# {
#   "id": "...",
#   "email": "admin@example.com",
#   "first_name": "",
#   "last_name": "",
#   "is_active": true,
#   "roles": ["admin"]
#   // ‚ùå NO debe tener "practitioner_calendly_url"
# }
```

### Frontend: Verificar Navegaci√≥n de Fechas

```javascript
// 9. Abrir DevTools Console en Agenda y ejecutar:
// Verificar que setSelectedDate funciona
const prevDate = document.querySelector('input[type="date"]').value;
document.querySelector('button[aria-label*="Next"]').click();
setTimeout(() => {
  const nextDate = document.querySelector('input[type="date"]').value;
  console.log('Prev:', prevDate, 'Next:', nextDate, 'Changed:', prevDate !== nextDate);
}, 100);
```

---

## SIGUIENTES PASOS RECOMENDADOS

### PASO 1: Crear Practitioner para Admin (üî¥ CR√çTICO - DESBLOQUEANTE)

```bash
# Opci√≥n A: Via Django Shell
docker exec -it emr-api-dev python manage.py shell

>>> from apps.authz.models import User, Practitioner
>>> user = User.objects.get(email='admin@example.com')
>>> practitioner = Practitioner.objects.create(
...     user=user,
...     display_name='Admin User',
...     role_type='practitioner',
...     specialty='Dermatology',
...     calendly_url='https://calendly.com/admin/30min',  # ‚ö†Ô∏è Reemplazar con URL real
...     is_active=True
... )
>>> print('Created:', practitioner)
```

```bash
# Opci√≥n B: Via Script (si existe)
docker exec emr-api-dev python scripts/demo_admin_user_creation.py
```

### PASO 2: Configurar Webhook en Calendly

1. Login a [Calendly](https://calendly.com/app/organization/webhooks)
2. Create Webhook:
   - **Webhook URL**: `https://yourdomain.com/api/integrations/calendly/webhook/`
   - **Events**: `invitee.created`, `invitee.canceled`
3. Copy signing key (e.g., `wbs_abc123...`)
4. Agregar a `.env`:
   ```bash
   CALENDLY_WEBHOOK_SECRET=wbs_abc123...
   ```
5. Reiniciar API:
   ```bash
   docker restart emr-api-dev
   ```

### PASO 3: Verificar Frontend

1. Logout y Login nuevamente
2. Verificar `/api/auth/me` ahora incluye `practitioner_calendly_url`
3. Navegar a `/schedule` ‚Üí Verificar que embed se muestra
4. Crear cita de prueba
5. Verificar logs:
   ```bash
   docker logs -f emr-api-dev | grep CALENDLY_WEBHOOK
   ```
6. Navegar a Agenda ‚Üí Verificar que cita aparece

### PASO 4: Test de Navegaci√≥n de Fechas

1. Abrir Agenda: `http://localhost:3000/en/`
2. Abrir DevTools ‚Üí Console
3. Click en flecha ‚Üí varias veces
4. Verificar URL cambia: `?date=2025-12-28`, `?date=2025-12-29`
5. Verificar Network: `GET /api/v1/clinical/appointments/?date=2025-12-28`

---

## RESUMEN DE HALLAZGOS

| Problema | Causa Ra√≠z | Archivo Afectado | L√≠nea | Severidad | Bloqueante |
|----------|-----------|------------------|-------|-----------|------------|
| #1 Flecha ‚Üí NO avanza | Probablemente test incompleto (c√≥digo correcto) | `apps/web/src/app/[locale]/page.tsx` | 158-169 | ‚ö†Ô∏è Media | ‚ùå No |
| #2 Calendly pantalla intermedia | Admin NO tiene `Practitioner` ‚Üí `practitioner_calendly_url` undefined | `apps/api/apps/authz/models.py` (Practitioner table) | - | üî¥ Cr√≠tica | ‚úÖ S√≠ |
| #3 Cita NO aparece en Agenda | Consecuencia de #2: NO hay embed funcional | Multiple | - | üî¥ Cr√≠tica | ‚úÖ S√≠ |
| #4 CALENDLY_WEBHOOK_SECRET NO configurado | Variable de entorno falta | `.env` | - | ‚ö†Ô∏è Media | ‚úÖ S√≠ (para webhook) |
| #5 Calendly URL es Scheduling Page | URL NO apunta a event type espec√≠fico | `Practitioner.calendly_url` | - | ‚ö†Ô∏è Baja | ‚ùå No |

---

## M√âTRICAS DE IMPLEMENTACI√ìN

**C√≥digo Backend (Webhook)**:
- ‚úÖ Implementado completamente (`apps/api/apps/integrations/views.py`)
- ‚úÖ Funci√≥n `_process_calendly_sync()` centralizada
- ‚úÖ Validaci√≥n de firma HMAC-SHA256
- ‚úÖ Procesamiento de `invitee.created` y `invitee.canceled`
- ‚úÖ Logging con prefijo `[CALENDLY_WEBHOOK]`
- ‚úÖ Idempotencia (get_or_create por external_id)

**C√≥digo Frontend (Embed)**:
- ‚úÖ Componente `CalendlyEmbed` implementado
- ‚úÖ Hook `useCalendlyConfig()` implementado
- ‚úÖ Validaci√≥n de URL interna de Calendly
- ‚úÖ Componente `CalendlyNotConfigured` para fallback

**Infraestructura**:
- ‚úÖ Endpoint `/api/integrations/calendly/webhook/` registrado
- ‚úÖ Endpoint `/api/v1/clinical/appointments/` registrado
- ‚úÖ Serializer `UserProfileSerializer` incluye `practitioner_calendly_url`

**Configuraci√≥n Faltante**:
- ‚ùå Usuario `admin@example.com` NO tiene `Practitioner`
- ‚ùå `CALENDLY_WEBHOOK_SECRET` NO configurado (probablemente)
- ‚ùå Webhook NO configurado en Calendly dashboard (probablemente)

---

## RELACIONADO

- ¬ß12.14: Auditor√≠a Encounter / Appointment / Agenda / Calendly (FASE 4.0)
- ¬ß12.15: Calendly Configuration per Practitioner
- ¬ß12.17: CalendlyEmbed Component
- ¬ß12.40: Calendly Webhook ‚Üí Sync Integration

---

## CONCLUSIONES

### Problema Real vs Problema Percibido

**Usuario reporta**: "3 cosas no funcionan"

**Realidad t√©cnica**:
1. ‚úÖ C√≥digo de navegaci√≥n de fechas: CORRECTO
2. ‚ùå Configuraci√≥n de datos: INCOMPLETA (falta `Practitioner`)
3. ‚úÖ C√≥digo de webhook: CORRECTO
4. ‚ùå Configuraci√≥n de infraestructura: INCOMPLETA (falta webhook en Calendly)

### Bloqueantes Cr√≠ticos

1. **Admin NO tiene Practitioner** ‚Üí Bloquea embed ‚Üí Bloquea todo test de Calendly
2. **Webhook NO configurado** ‚Üí Bloquea sincronizaci√≥n autom√°tica

### C√≥digo Funcional (Sin Modificar)

El c√≥digo implementado es correcto y NO requiere cambios. Los problemas son de:
- **Configuraci√≥n de datos**: Falta crear `Practitioner` para admin
- **Configuraci√≥n de infraestructura**: Falta webhook en Calendly dashboard
- **Testing incompleto**: Navegaci√≥n de fechas probablemente funciona

### Recomendaci√≥n Final

**NO modificar c√≥digo**. Ejecutar pasos de configuraci√≥n:
1. Crear `Practitioner` para admin con `calendly_url` v√°lida
2. Configurar webhook en Calendly dashboard
3. Agregar `CALENDLY_WEBHOOK_SECRET` a `.env`
4. Re-test completo de flujo end-to-end

---

**FIN DE AUDITOR√çA**
